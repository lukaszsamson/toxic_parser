# Refactoring Opportunities (Codex Pass)

- **Normalize dot-call handling:** `TokenAdapter` collapses `dot_call_op` into `dot_op` while `Pratt.led/5` still has a `:dot_call_op` branch. Either restore the distinct token or remove the dead branch to avoid misleading control flow.
- **Unify paren-call builders:** Paren-call metadata/newlines logic is duplicated across `Calls.parse_paren_call/4`, `Calls.parse_paren_call_no_led/4`, `Pratt.parse_paren_call_base/4`, and dot-call paths. Extract a shared helper (callee meta + leading/trailing newline accounting + closing meta) to reduce drift.
- **Consolidate do-block attachment logic:** `maybe_do_block/4`, `maybe_do_block_no_led/4`, and `maybe_do_block_with_min_bp/6` duplicate behavior and differ subtly on metadata and context gating. Centralize do-block attachment with explicit context handling to avoid regressions.
- **Factor EOE skipping:** Variants of `skip_eoe` and `skip_eoe_count_newlines` appear in Expressions, Calls, Dots, Blocks, Containers, Keywords, Pratt. A small shared utility would reduce repetition and ensure consistent newline accounting.
- **Reassess precedence table:** `Precedence` contains dead/misleading entries (`unary_not_op`, high `dot_op`, `ellipsis_op` bp) while Pratt overrides some values. Align the table with actual use or delete unused rows to prevent future misbinding bugs.
- **Streamline map-update heuristic:** `Maps.try_parse_map_update/3` mixes checkpointing, bp checks, and assoc/unary-do-block guards inline. Extract guard predicates (assoc? unary-with-do-block?) and pipe metadata building to improve readability/testability.
- **Simplify dot member parsing:** `Dots.parse_member/3` intertwines identifier classification with call/bracket/quoted handling and returns heterogeneous tuples (`{atom, meta}`, `{atom, meta, :no_parens_call}`, AST). Consider separating token classification from call/bracket parsing to reduce branching and pattern-matching noise.
- **Deduplicate no-parens arg parsing:** Pratt’s `parse_no_parens_args_with_min_bp/5` and Calls’ `parse_no_parens_args/4` are near-copies with slight differences (min_bp, comma/keyword merging). A unified implementation with optional min_bp would eliminate divergence.
- **Builder/meta helpers:** Token-to-meta conversion (`token_meta`, `build_meta`) and dot/call metadata assembly are re-implemented in several modules. Centralizing metadata composition (newlines, closing, parens, from_brackets) would reduce repeated keyword list churn.

